<!DOCTYPE html>
<html lang="id">
<head>
    <title>Simulasi TKA Kecamatan</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
        /* --- GAYA TAMPILAN LOGIN (BAWAAN ANDA) --- */
        body { background-color: #f0f3f5; font-family: sans-serif; overflow-x: hidden; }
        .header-top { background:#326698; height:130px; position:fixed; top:0; left:0; right:0; z-index:999; }
        .wrapper-login { margin-top: 140px; }
        .card-login {
            background: #fff; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px; min-height: 400px;
        }
        .input-clean { border: none; border-bottom: 1px solid #ccc; width: 100%; padding: 5px; background: transparent; }
        .input-clean:focus { outline: none; border-bottom: 2px solid #326698; }
        
        /* --- GAYA TAMPILAN UJIAN (MODE ANBK) --- */
        #view-ujian { display: none; padding-top: 140px; } /* Tersembunyi awal */
        .info-peserta-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: #2c3e50; color: white; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .timer-badge { background: #e74c3c; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        
        /* Layout Soal */
        .soal-container { background: #fff; padding: 20px; border-radius: 5px; min-height: 60vh; font-size: 18px; }
        .soal-img { max-width: 100%; height: auto; margin-bottom: 15px; border: 1px solid #ddd; }
        .opsi-block { margin-top: 20px; }
        .radio-custom { transform: scale(1.5); margin-right: 10px; cursor: pointer; }
        .label-opsi { cursor: pointer; width: 100%; display: block; padding: 5px; }
        .label-opsi:hover { background-color: #f9f9f9; }

        /* Panel Navigasi (Kanan) */
        .nav-panel { background: #fff; padding: 15px; border-radius: 5px; }
        .nomor-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .nomor-item {
            border: 1px solid #333; text-align: center; padding: 8px 0; cursor: pointer; font-size: 14px;
        }
        .nomor-item.active { border: 2px solid #326698; font-weight: bold; }
        .nomor-item.answered { background-color: #333; color: white; border-color: #000; }
        .nomor-item.ragu { background-color: #f1c40f; color: black; border-color: #d35400; }
        
        /* Tombol Navigasi Bawah */
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #ddd; padding: 10px; z-index: 1000; text-align: center; }

        /* Loader */
        .loader-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8);
            z-index: 99999; display: none; align-items: center; justify-content: center;
        }
        
        /* Font Sizer */
        .font-control { cursor: pointer; margin-left: 10px; color: #ccc; }
        .font-control:hover { color: #fff; }

        /* Sekoci Darurat */
        .emergency-box { display: none; margin-top: 20px; border: 2px dashed red; padding: 15px; background: #fff0f0; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader">
    <div class="text-center">
        <img src="https://pusmendik.kemdikbud.go.id/tka/_assets/images/loader2.gif" width="50"><br>
        <b id="loader-text">Memuat...</b>
    </div>
</div>

<div id="view-login">
    <div class="container-fluid text-white header-top">
        <div class="row pt-2 pl-4">
            <div class="col-auto">
                <img src="https://pusmendik.kemdikbud.go.id/tka/images/logo-kemdikbud-71x72.png" height="70">
            </div>
            <div class="col">
                <h4 class="mt-2">SIMULASI TKA KECAMATAN</h4>
                <small>Aplikasi Ujian Berbasis Komputer</small>
            </div>
        </div>
    </div>

    <div class="container wrapper-login">
        <div class="row justify-content-center">
            <div class="col-md-7 mb-4">
                <div class="card-login" style="background: url('https://pusmendik.kemdikbud.go.id/tka/images/logo-w.png') no-repeat top right; background-size: 200px;">
                    <h3>Selamat Datang</h3>
                    <p>Silakan masukkan NISN dan Token yang diberikan oleh Proktor/Guru.</p>
                    <div class="alert alert-info mt-5">
                        <b>Status Token:</b> <span id="token-status">LIHAT PAPAN TULIS</span>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card-login">
                    <h4 class="mb-4">Konfirmasi Data Peserta</h4>
                    <form id="formLogin" onsubmit="return false;">
                        <div class="form-group">
                            <label><small><b>NISN / ID Peserta</b></small></label>
                            <input type="text" class="input-clean" id="input-nisn" placeholder="Contoh: 00123456" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label><small><b>Token Ujian</b></small></label>
                            <input type="text" class="input-clean" id="input-token" placeholder="Ketik Token (Huruf Besar)" required autocomplete="off">
                        </div>
                        
                        <div class="mt-5">
                            <button class="btn btn-primary btn-block btn-lg rounded-pill" onclick="prosesLogin()">SUBMIT</button>
                        </div>
                    </form>
                    <div id="login-error" class="text-danger mt-2 small text-center"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-ujian">
    <div class="info-peserta-bar">
        <div>
            <span id="nama-siswa-display">Peserta</span> | <span id="sekolah-display">Sekolah</span>
        </div>
        <div>
            <span class="font-control" onclick="ubahFont(16)">A</span>
            <span class="font-control" onclick="ubahFont(20)">A+</span>
            <span class="font-control" onclick="ubahFont(24)">A++</span>
            <span class="ml-3 timer-badge" id="timer-display">00:00:00</span>
        </div>
    </div>

    <div class="container-fluid pl-4 pr-4">
        <div class="row">
            <div class="col-md-9 mb-5">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between">
                            <h5 class="m-0 text-primary">SOAL NO. <span id="no-soal-display">1</span></h5>
                            <small class="text-muted" id="tipe-soal">Pilihan Ganda</small>
                        </div>
                    </div>
                    <div class="card-body soal-container" id="kontainer-soal">
                        </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="nav-panel shadow-sm">
                    <h6>Navigasi Soal</h6>
                    <div class="nomor-grid" id="grid-nomor">
                        </div>
                    <hr>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="check-ragu" onchange="toggleRagu()">
                        <label class="form-check-label text-warning font-weight-bold" for="check-ragu">Ragu - Ragu</label>
                    </div>
                    <div class="mt-3 text-center">
                        <small>Hijau: Dijawab | Kuning: Ragu</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-nav shadow">
        <div class="container">
            <div class="row">
                <div class="col-4 text-left">
                    <button class="btn btn-danger" id="btn-prev" onclick="gantiSoal(-1)"><i class="fa fa-chevron-left"></i> Sebelumnya</button>
                </div>
                <div class="col-4 text-center">
                    <span id="status-simpan" class="badge badge-light">Siap</span>
                </div>
                <div class="col-4 text-right">
                    <button class="btn btn-primary" id="btn-next" onclick="gantiSoal(1)">Selanjutnya <i class="fa fa-chevron-right"></i></button>
                    <button class="btn btn-success" id="btn-selesai" onclick="konfirmasiSelesai()" style="display:none;">Selesai Ujian</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSelesai" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Selesai</h5>
            </div>
            <div class="modal-body">
                <p>Apakah Anda yakin ingin mengakhiri ujian ini?</p>
                <p><small>Pastikan tidak ada jawaban yang statusnya "Ragu-ragu".</small></p>
                
                <div class="emergency-box" id="box-darurat">
                    <b>⚠️ KONEKSI GAGAL!</b>
                    <p class="small">Jangan panik. Sistem gagal mengirim data ke server. Foto kode di bawah ini dan kirim ke Guru:</p>
                    <textarea class="form-control" rows="4" id="kode-penyelamat" readonly></textarea>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btn-kirim-server" onclick="kirimJawaban()">Ya, Selesai</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI UTAMA ---
    // URL Web App GAS Anda (PASTE DISINI)
    const API_URL = "https://script.google.com/macros/s/AKfycbyWJx6CT3JTr-Of1hwuTDavdXyAjFZQxTxQwnPS466iR8-lWQantSuOtAlUFxXx0DFo/exec"; 

    // Variabel Global
    let DATA_SISWA = {};
    let PAKET_SOAL = [];
    let JAWABAN_SISWA = {}; // Format: { "1": "A", "2": "C" }
    let RAGU_RAGU = {};     // Format: { "1": true }
    let CURRENT_INDEX = 0;
    let TIMER_INTERVAL;
    
    // --- 1. SISTEM LOGIN ---
    function prosesLogin() {
        let nisn = $('#input-nisn').val().trim();
        let token = $('#input-token').val().trim();

        if(!nisn || !token) { alert("NISN dan Token harus diisi!"); return; }

        // Tampilkan Loader
        $('#loader').css('display', 'flex');
        $('#loader-text').text('Memeriksa Data Peserta...');

        $.ajax({
            url: API_URL,
            type: "POST",
            data: { action: "login", nisn: nisn, token: token },
            dataType: "json",
            success: function(resp) {
                if(resp.status === "SUKSES") {
                    DATA_SISWA = resp.data;
                    PAKET_SOAL = resp.data.soal;
                    
                    // Simpan NISN untuk keperluan LocalStorage
                    localStorage.setItem('current_nisn', DATA_SISWA.nisn);
                    
                    siapkanUjian();
                } else {
                    alert(resp.pesan);
                    $('#loader').fadeOut();
                }
            },
            error: function(err) {
                console.log(err);
                alert("Gagal terhubung ke server. Periksa koneksi internet.");
                $('#loader').fadeOut();
            }
        });
    }

    // --- 2. PERSIAPAN UJIAN (SETUP) ---
    function siapkanUjian() {
        // Hide Login, Show Ujian
        $('#view-login').fadeOut(500, function() {
            $('#view-ujian').fadeIn();
        });
        $('#loader').fadeOut();

        // Isi Info Peserta
        $('#nama-siswa-display').text(DATA_SISWA.nama);
        $('#sekolah-display').text(DATA_SISWA.sekolah);

        // Cek LocalStorage (Restore Jawaban Anti-Nangis)
        restoreSesiLokal();

        // Render Navigasi & Soal Pertama
        renderNavigasi();
        tampilkanSoal(0);
        
        // Mulai Timer (Durasi dari Server dalam Menit)
        mulaiTimer(DATA_SISWA.durasi * 60); 

        // Mode Fullscreen (Opsional, browser modern memblokir auto-fullscreen tanpa klik user)
        // document.documentElement.requestFullscreen().catch((e)=>{});
    }

    // --- 3. ENGINE UJIAN ---
    function tampilkanSoal(index) {
        if(index < 0 || index >= PAKET_SOAL.length) return;
        
        CURRENT_INDEX = index;
        let soal = PAKET_SOAL[index];
        let idSoal = soal.id;

        // Update Header Soal
        $('#no-soal-display').text(index + 1);
        $('#tipe-soal').text(soal.tipe === 'PG' ? 'Pilihan Ganda' : 'Isian');

        // Render Konten
        let html = '';
        if(soal.gambar) {
            html += `<img src="${soal.gambar}" class="soal-img"><br>`;
        }
        html += `<p>${soal.text}</p>`;
        
        // Render Opsi
        html += `<div class="opsi-block">`;
        soal.opsi.forEach(op => {
            let isChecked = (JAWABAN_SISWA[index + 1] === op.id) ? 'checked' : '';
            html += `
                <div class="d-flex align-items-center mb-3">
                    <input type="radio" name="jawaban" class="radio-custom" id="opt_${op.id}" value="${op.id}" onchange="pilihJawaban('${op.id}')" ${isChecked}>
                    <label class="label-opsi ml-2" for="opt_${op.id}">
                         <b>${op.id}.</b> ${op.val}
                    </label>
                </div>
            `;
        });
        html += `</div>`;

        $('#kontainer-soal').html(html);

        // Update tombol navigasi
        $('#btn-prev').prop('disabled', index === 0);
        
        if (index === PAKET_SOAL.length - 1) {
            $('#btn-next').hide();
            $('#btn-selesai').show();
        } else {
            $('#btn-next').show();
            $('#btn-selesai').hide();
        }

        // Set status checkbox Ragu
        $('#check-ragu').prop('checked', RAGU_RAGU[index + 1] || false);

        // Update Grid Aktif
        $('.nomor-item').removeClass('active');
        $(`#grid-btn-${index+1}`).addClass('active');
    }

    function gantiSoal(arah) {
        tampilkanSoal(CURRENT_INDEX + arah);
    }

    function lompatSoal(nomor) {
        tampilkanSoal(nomor - 1);
    }

    // --- 4. LOGIKA SIMPAN & LOCALSTORAGE ---
    function pilihJawaban(huruf) {
        let nomor = CURRENT_INDEX + 1;
        JAWABAN_SISWA[nomor] = huruf;
        
        // Simpan ke LocalStorage (Anti-Nangis)
        let key = `tka_${DATA_SISWA.nisn}_ans`;
        localStorage.setItem(key, JSON.stringify(JAWABAN_SISWA));

        updateNavigasiUI(nomor);
        
        // Efek visual simpan
        $('#status-simpan').text('Tersimpan').removeClass('badge-light').addClass('badge-success');
        setTimeout(() => {
             $('#status-simpan').text('Siap').removeClass('badge-success').addClass('badge-light');
        }, 1000);
    }

    function toggleRagu() {
        let nomor = CURRENT_INDEX + 1;
        let status = $('#check-ragu').is(':checked');
        RAGU_RAGU[nomor] = status;
        updateNavigasiUI(nomor);
    }

    function renderNavigasi() {
        let html = '';
        PAKET_SOAL.forEach((s, i) => {
            let num = i + 1;
            html += `<div class="nomor-item" id="grid-btn-${num}" onclick="lompatSoal(${num})">${num}</div>`;
        });
        $('#grid-nomor').html(html);
        
        // Refresh warna jika ada data restore
        PAKET_SOAL.forEach((s, i) => updateNavigasiUI(i + 1));
    }

    function updateNavigasiUI(nomor) {
        let el = $(`#grid-btn-${nomor}`);
        el.removeClass('answered ragu');
        
        if (RAGU_RAGU[nomor]) {
            el.addClass('ragu');
        } else if (JAWABAN_SISWA[nomor]) {
            el.addClass('answered');
        }
    }

    function restoreSesiLokal() {
        let key = `tka_${DATA_SISWA.nisn}_ans`;
        let saved = localStorage.getItem(key);
        if(saved) {
            JAWABAN_SISWA = JSON.parse(saved);
        }
    }

    // --- 5. SUBMIT JAWABAN (DENGAN RETRY & SEKOCI) ---
    function konfirmasiSelesai() {
        $('#modalSelesai').modal('show');
        $('#box-darurat').hide();
        $('#btn-kirim-server').show().text('Ya, Selesai').prop('disabled', false);
    }

    function kirimJawaban() {
        let payload = {
            action: "submit",
            nisn: DATA_SISWA.nisn,
            nama: DATA_SISWA.nama,
            sekolah: DATA_SISWA.sekolah,
            jawaban: JAWABAN_SISWA
        };

        // UI Loading di Modal
        $('#btn-kirim-server').prop('disabled', true).text('Mengirim...');
        
        // Retry Logic (Mencoba 3 kali)
        let attempt = 0;
        const maxAttempt = 3;

        function doAjax() {
            attempt++;
            $.ajax({
                url: API_URL,
                type: "POST",
                data: { action: "submit", data_jawaban: JSON.stringify(payload) },
                dataType: "json",
                success: function(resp) {
                    if(resp.status === "OK") {
                        alert("Terima Kasih! Jawaban Anda telah tersimpan.");
                        
                        // BERSIHKAN SESI LOKAL
                        localStorage.removeItem(`tka_${DATA_SISWA.nisn}_ans`);
                        
                        location.reload(); // Kembali ke login
                    } else {
                        handleFail();
                    }
                },
                error: function() {
                    if(attempt < maxAttempt) {
                        $('#btn-kirim-server').text(`Gagal, mencoba lagi (${attempt})...`);
                        setTimeout(doAjax, 2000); // Coba lagi setelah 2 detik
                    } else {
                        handleFail();
                    }
                }
            });
        }

        function handleFail() {
            // TAMPILKAN SEKOCI DARURAT
            let kodeAman = btoa(JSON.stringify(payload)); // Encode Base64
            $('#kode-penyelamat').val(kodeAman);
            $('#box-darurat').slideDown();
            $('#btn-kirim-server').hide();
            alert("Gagal terhubung ke server! Jangan tutup halaman. Silakan simpan KODE PENYELAMAT yang muncul.");
        }

        doAjax(); // Jalankan pertama kali
    }

    // --- 6. UTILS (Timer & Font) ---
    function ubahFont(size) {
        $('.soal-container').css('font-size', size + 'px');
    }

    function mulaiTimer(seconds) {
        let timeLeft = seconds;
        
        // Cek apakah ada sisa waktu tersimpan di lokal (opsional, untuk advanced)
        // Di sini kita pakai durasi baru setiap login agar simpel
        
        TIMER_INTERVAL = setInterval(function() {
            timeLeft--;
            
            let h = Math.floor(timeLeft / 3600);
            let m = Math.floor((timeLeft % 3600) / 60);
            let s = timeLeft % 60;
            
            $('#timer-display').text(
                (h<10?'0':'')+h + ":" + (m<10?'0':'')+m + ":" + (s<10?'0':'')+s
            );

            if(timeLeft <= 0) {
                clearInterval(TIMER_INTERVAL);
                alert("Waktu Habis! Jawaban akan dikirim otomatis.");
                kirimJawaban();
            }
        }, 1000);
    }
    
    // Peringatan jika mau refresh/tutup tab
    window.onbeforeunload = function() {
        if ($('#view-ujian').is(":visible")) {
            return "Apakah Anda yakin ingin keluar? Ujian sedang berlangsung.";
        }
    };
</script>

</body>
</html>
