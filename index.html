<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIMULASI TKA SD - Selogiri</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        diknas: '#005BB5', // Biru Dinas
                        diknasDark: '#004489',
                        accent: '#FFB300', // Kuning Emas
                        surface: '#F8FAFC',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F1F5F9; user-select: none; }
        .hidden-view { display: none !important; }
        
        /* Animasi */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Pilihan Ganda Radio Style */
        .option-radio:checked + div {
            border-color: #005BB5;
            background-color: #E0F2FE;
        }
        .option-radio:checked + div .indicator {
            background-color: #005BB5;
            color: white;
            border-color: #005BB5;
        }

        /* Navigasi Grid Status */
        .nav-btn.answered { background-color: #005BB5; color: white; border-color: #005BB5; }
        .nav-btn.ragu { background-color: #FFB300; color: black; border-color: #FFB300; }
        .nav-btn.active { ring: 2px solid #000; ring-offset: 2px; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col font-sans">

    <script>
        // URL API SUDAH SAYA MASUKKAN SESUAI LINK YANG ANDA BERIKAN
        const API_URL = "https://script.google.com/macros/s/AKfycbxfxLh0GZ8p0jmqoYIo8LKMXXlySPL0BKzsyV4dm-9p4yy2zh7vqFYnpldgARbqWw7BKw/exec"; 
    </script>

    <div id="loading" class="fixed inset-0 bg-white/90 z-[100] flex flex-col items-center justify-center backdrop-blur-sm hidden-view">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-diknas mb-4"></div>
        <p class="text-diknas font-bold animate-pulse tracking-wider">MENGHUBUNGKAN SERVER...</p>
        <p class="text-xs text-slate-400 mt-2">Mohon tunggu sebentar</p>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[110] flex flex-col gap-2"></div>

    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-4 min-h-screen relative">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 fade-in z-10">
            <div class="bg-diknas p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                
                <h1 class="text-white font-extrabold text-2xl tracking-wide mb-1">SIMULASI TKA SD</h1>
                <div class="h-1 w-16 bg-accent mx-auto mb-2 rounded-full"></div>
                <p class="text-blue-100 text-sm font-medium">Korwilcambidik Kecamatan Selogiri</p>
            </div>

            <div class="p-8 space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Asal Sekolah</label>
                    <select id="inp-sekolah" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg font-semibold focus:ring-2 focus:ring-diknas outline-none">
                        <option value="">-- Sedang Memuat Data... --</option>
                        </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                    <input type="text" id="inp-nama" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg font-semibold focus:ring-2 focus:ring-diknas outline-none uppercase" placeholder="CONTOH: BUDI SANTOSO">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIS/NISN</label>
                        <input type="text" id="inp-nis" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg font-semibold focus:ring-2 focus:ring-diknas outline-none" placeholder="Nomor Induk">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Token Ujian</label>
                        <input type="text" id="inp-token" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg font-semibold focus:ring-2 focus:ring-diknas outline-none uppercase" placeholder="KODE TOKEN">
                    </div>
                </div>

                <button onclick="doLogin()" class="w-full py-4 bg-diknas hover:bg-diknasDark text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                    MULAI UJIAN <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
                
                <p class="text-center text-[10px] text-slate-400 mt-4">Pastikan koneksi internet lancar sebelum memulai.</p>
            </div>
        </div>

        <div class="mt-8 text-center">
            <p class="text-slate-400 text-xs font-semibold">2026 | Tim Kreatif Kecamatan Selogiri</p>
        </div>
    </div>

    <div id="view-ujian" class="hidden-view flex flex-col h-screen bg-slate-100">
        
        <header class="bg-diknas text-white shadow-md z-20 sticky top-0">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex flex-col justify-center">
                    <h2 class="font-bold text-lg leading-none mb-1">SIMULASI TKA SD</h2>
                    <p class="text-[10px] text-blue-200" id="header-nama">Siswa</p>
                </div>

                <div class="bg-black/20 px-4 py-1.5 rounded-full border border-white/20 flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4 text-accent"></i>
                    <span id="timer-display" class="font-mono font-bold text-lg tracking-widest text-accent">00:00:00</span>
                </div>

                <button onclick="toggleSidebar()" class="md:hidden bg-white/10 p-2 rounded-lg">
                    <i data-lucide="grid" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            
            <main class="flex-1 overflow-y-auto p-4 md:p-8" id="main-scroll">
                <div class="max-w-4xl mx-auto pb-24">
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[60vh] flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl">
                            <span class="bg-diknas text-white text-xs font-bold px-3 py-1 rounded-full">SOAL NO. <span id="soal-no-display">1</span></span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 uppercase">Ukuran Font:</span>
                                <button onclick="changeFont(-2)" class="w-6 h-6 bg-white border rounded text-xs font-bold">A-</button>
                                <button onclick="changeFont(2)" class="w-6 h-6 bg-white border rounded text-xs font-bold">A+</button>
                            </div>
                        </div>

                        <div class="p-6 flex-1">
                            <div id="soal-img-container" class="mb-4 hidden-view">
                                <img id="soal-img" src="" class="max-w-full h-auto max-h-64 rounded-lg border border-slate-200 mx-auto" alt="Gambar Soal">
                            </div>
                            <div id="soal-text" class="text-slate-800 font-medium text-lg leading-relaxed mb-8">
                                Memuat Soal...
                            </div>

                            <div id="opsi-container" class="space-y-3 max-w-2xl">
                                </div>
                        </div>
                    </div>

                </div>
            </main>

            <aside id="sidebar-nav" class="bg-white w-72 border-l border-slate-200 flex flex-col absolute md:relative right-0 h-full transform translate-x-full md:translate-x-0 transition-transform duration-300 z-10 shadow-2xl md:shadow-none">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="layout-grid" class="w-4 h-4"></i> Daftar Soal</h3>
                    <button onclick="toggleSidebar()" class="md:hidden"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="grid-navigasi" class="grid grid-cols-5 gap-2">
                        </div>
                </div>

                <div class="p-4 border-t border-slate-100 bg-slate-50">
                    <div class="flex gap-2 text-[10px] font-bold text-slate-500 mb-4 justify-center">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-diknas rounded-sm"></div> Isi</div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-accent rounded-sm"></div> Ragu</div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-white border border-slate-300 rounded-sm"></div> Kosong</div>
                    </div>
                    <button onclick="finishExam()" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow transition text-sm flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> SELESAI UJIAN
                    </button>
                </div>
            </aside>

        </div>

        <footer class="bg-white border-t border-slate-200 p-3 z-20">
            <div class="container mx-auto max-w-4xl flex justify-between items-center">
                <button onclick="navSoal(-1)" id="btn-prev" class="px-4 py-2 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-50 flex items-center gap-2 disabled:opacity-50">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> <span class="hidden sm:inline">SEBELUMNYA</span>
                </button>

                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer select-none bg-yellow-50 px-4 py-2 rounded-lg border border-yellow-200 hover:bg-yellow-100 transition">
                        <input type="checkbox" id="chk-ragu" onchange="toggleRagu()" class="w-4 h-4 text-accent focus:ring-accent border-gray-300 rounded">
                        <span class="text-sm font-bold text-yellow-700">RAGU-RAGU</span>
                    </label>
                </div>

                <button onclick="navSoal(1)" id="btn-next" class="px-4 py-2 rounded-lg bg-diknas text-white font-bold text-sm hover:bg-diknasDark shadow-lg shadow-blue-100 flex items-center gap-2">
                    <span class="hidden sm:inline">SELANJUTNYA</span> <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
        </footer>

    </div>

    <div id="view-selesai" class="hidden-view min-h-screen flex flex-col items-center justify-center bg-white p-6 text-center fade-in">
        <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-6">
            <i data-lucide="check" class="w-12 h-12"></i>
        </div>
        <h2 class="text-3xl font-bold text-slate-800 mb-2">Terima Kasih!</h2>
        <p class="text-slate-500 mb-8 max-w-md">Jawaban Anda telah berhasil disimpan ke server. Silakan lapor kepada pengawas.</p>
        
        <div id="score-card" class="hidden-view bg-slate-50 p-6 rounded-2xl border border-slate-200 w-full max-w-xs mb-8">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">SKOR ANDA</p>
            <p class="text-5xl font-black text-diknas" id="lbl-skor">0</p>
        </div>

        <button onclick="location.reload()" class="px-8 py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 transition">
            Keluar Aplikasi
        </button>
        <div class="mt-8 text-center">
            <p class="text-slate-300 text-[10px] font-semibold">2026 | Tim Kreatif Kecamatan Selogiri</p>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let DATA_SEKOLAH = [];
        let SOAL_LIST = [];
        let CURRENT_IDX = 0;
        let JAWABAN = {}; // {id_soal: 'A'}
        let RAGU = {}; // {id_soal: true}
        let TIMER_INTERVAL;
        let TIME_LEFT = 0;
        let USER_INFO = {};
        let FONT_SIZE = 18; // default px

        // --- INIT ---
        window.onload = async () => {
            lucide.createIcons();
            
            toggleLoading(true);
            try {
                // Fetch Data Awal
                const res = await apiRequest({ action: 'getInit' });
                if(res && res.status === 'sukses') {
                    // Populate Sekolah
                    const sel = document.getElementById('inp-sekolah');
                    sel.innerHTML = '<option value="">-- Pilih Sekolah --</option>'; // Reset
                    res.sekolah.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.innerText = s;
                        sel.appendChild(opt);
                    });
                } else {
                    throw new Error("Respon server tidak valid");
                }
            } catch (e) {
                console.error(e);
                const sel = document.getElementById('inp-sekolah');
                sel.innerHTML = '<option value="">-- Gagal Memuat Data --</option>';
                
                // Pesan Error yang lebih ramah
                if(confirm("Gagal terhubung ke Database.\nKemungkinan koneksi internet tidak stabil atau server sedang sibuk.\n\nKlik OK untuk mencoba memuat ulang.")) {
                    location.reload();
                }
            }
            toggleLoading(false);
        };

        // --- AUTH & LOGIN ---
        async function doLogin() {
            const sekolah = document.getElementById('inp-sekolah').value;
            const nama = document.getElementById('inp-nama').value;
            const nis = document.getElementById('inp-nis').value;
            const token = document.getElementById('inp-token').value;

            if(!sekolah || !nama || !nis || !token) {
                showToast("Semua data wajib diisi!", "error");
                return;
            }

            toggleLoading(true);
            try {
                const res = await apiRequest({ action: 'login', token: token });
                toggleLoading(false);

                if(res.status === 'sukses') {
                    USER_INFO = { sekolah, nama, nis };
                    SOAL_LIST = res.soal;
                    
                    const saved = localStorage.getItem(`ans_${nis}`);
                    if(saved) JAWABAN = JSON.parse(saved);

                    startExam();
                } else {
                    showToast(res.message || "Token Salah atau Data tidak ditemukan", "error");
                }
            } catch (e) {
                toggleLoading(false);
                alert("Terjadi kesalahan saat Login. Cek koneksi internet Anda.");
            }
        }

        // --- EXAM LOGIC ---
        function startExam() {
            document.getElementById('view-login').classList.add('hidden-view');
            document.getElementById('view-ujian').classList.remove('hidden-view');
            document.getElementById('header-nama').innerText = USER_INFO.nama;

            // Generate Navigasi Grid
            const grid = document.getElementById('grid-navigasi');
            grid.innerHTML = '';
            SOAL_LIST.forEach((s, i) => {
                const btn = document.createElement('button');
                btn.className = `nav-btn w-10 h-10 rounded-lg border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 transition`;
                btn.innerText = i + 1;
                btn.id = `nav-${i}`;
                btn.onclick = () => jumpTo(i);
                grid.appendChild(btn);
            });

            TIME_LEFT = 90 * 60; 
            startTimer();

            CURRENT_IDX = 0;
            renderSoal();
            updateNavGrid();
        }

        function renderSoal() {
            const soal = SOAL_LIST[CURRENT_IDX];
            
            document.getElementById('soal-no-display').innerText = CURRENT_IDX + 1;
            
            const imgCont = document.getElementById('soal-img-container');
            const img = document.getElementById('soal-img');
            if(soal.img) {
                imgCont.classList.remove('hidden-view');
                img.src = soal.img;
            } else {
                imgCont.classList.add('hidden-view');
            }

            const txt = document.getElementById('soal-text');
            txt.innerHTML = soal.text;
            txt.style.fontSize = `${FONT_SIZE}px`;

            const container = document.getElementById('opsi-container');
            container.innerHTML = '';

            const myAns = JAWABAN[soal.id] || "";

            if(soal.tipe === 'PG') {
                ['A','B','C','D'].forEach((key, idx) => {
                    const val = soal.opsi[idx];
                    if(!val) return; 

                    const wrapper = document.createElement('label');
                    wrapper.className = "flex cursor-pointer group";
                    wrapper.innerHTML = `
                        <input type="radio" name="ans" class="option-radio hidden" value="${key}" ${myAns === key ? 'checked' : ''} onchange="saveAnswer('${soal.id}', '${key}')">
                        <div class="flex-1 p-4 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex items-start gap-4 group-hover:border-diknas/50">
                            <div class="indicator w-8 h-8 rounded-lg border border-slate-300 flex items-center justify-center font-bold text-slate-500 shrink-0 transition">${key}</div>
                            <div class="text-sm font-medium text-slate-700 pt-1.5">${val}</div>
                        </div>
                    `;
                    container.appendChild(wrapper);
                });
            } else if (soal.tipe === 'ISIAN') {
                container.innerHTML = `
                    <input type="text" value="${myAns}" onchange="saveAnswer('${soal.id}', this.value)" 
                    class="w-full p-4 border border-slate-300 rounded-xl font-bold text-lg focus:ring-2 focus:ring-diknas outline-none" 
                    placeholder="Ketik jawaban Anda di sini...">
                `;
            }

            document.getElementById('btn-prev').disabled = CURRENT_IDX === 0;
            const btnNext = document.getElementById('btn-next');
            if(CURRENT_IDX === SOAL_LIST.length - 1) {
                btnNext.innerHTML = `<span class="hidden sm:inline">SELESAI</span> <i data-lucide="check-circle" class="w-4 h-4"></i>`;
                btnNext.classList.replace('bg-diknas', 'bg-green-600');
                btnNext.onclick = finishExam; 
            } else {
                btnNext.innerHTML = `<span class="hidden sm:inline">SELANJUTNYA</span> <i data-lucide="chevron-right" class="w-4 h-4"></i>`;
                btnNext.classList.replace('bg-green-600', 'bg-diknas');
                btnNext.onclick = () => navSoal(1);
            }

            document.getElementById('chk-ragu').checked = !!RAGU[soal.id];
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${CURRENT_IDX}`).classList.add('active');
            
            lucide.createIcons();
            document.getElementById('main-scroll').scrollTop = 0;
        }

        function saveAnswer(idSoal, val) {
            JAWABAN[idSoal] = val;
            localStorage.setItem(`ans_${USER_INFO.nis}`, JSON.stringify(JAWABAN));
            updateNavGrid();
        }

        function toggleRagu() {
            const idSoal = SOAL_LIST[CURRENT_IDX].id;
            const status = document.getElementById('chk-ragu').checked;
            if(status) RAGU[idSoal] = true;
            else delete RAGU[idSoal];
            updateNavGrid();
        }

        function updateNavGrid() {
            SOAL_LIST.forEach((s, i) => {
                const btn = document.getElementById(`nav-${i}`);
                const isAns = JAWABAN[s.id] && JAWABAN[s.id] !== "";
                const isRagu = RAGU[s.id];

                btn.classList.remove('answered', 'ragu');
                
                if(isRagu) btn.classList.add('ragu');
                else if(isAns) btn.classList.add('answered');
            });
        }

        function navSoal(dir) {
            const next = CURRENT_IDX + dir;
            if(next >= 0 && next < SOAL_LIST.length) {
                CURRENT_IDX = next;
                renderSoal();
            }
        }
        
        function jumpTo(idx) {
            CURRENT_IDX = idx;
            renderSoal();
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar-nav');
            sb.classList.toggle('translate-x-full');
        }

        function changeFont(delta) {
            FONT_SIZE += delta;
            if(FONT_SIZE < 14) FONT_SIZE = 14;
            if(FONT_SIZE > 32) FONT_SIZE = 32;
            renderSoal();
        }

        function startTimer() {
            const disp = document.getElementById('timer-display');
            TIMER_INTERVAL = setInterval(() => {
                TIME_LEFT--;
                
                const h = Math.floor(TIME_LEFT / 3600).toString().padStart(2,'0');
                const m = Math.floor((TIME_LEFT % 3600) / 60).toString().padStart(2,'0');
                const s = (TIME_LEFT % 60).toString().padStart(2,'0');
                
                disp.innerText = `${h}:${m}:${s}`;
                
                if(TIME_LEFT === 300) showToast("Waktu tinggal 5 menit!", "error");

                if(TIME_LEFT <= 0) {
                    clearInterval(TIMER_INTERVAL);
                    alert("Waktu Habis! Jawaban akan dikirim otomatis.");
                    submitToServer();
                }
            }, 1000);
        }

        function finishExam() {
            const answeredCount = Object.keys(JAWABAN).length;
            const total = SOAL_LIST.length;
            
            let msg = `Anda baru menjawab ${answeredCount} dari ${total} soal. Yakin ingin mengakhiri?`;
            if(answeredCount === total) msg = "Apakah Anda yakin ingin menyelesaikan ujian ini?";
            
            if(confirm(msg)) {
                submitToServer();
            }
        }

        async function submitToServer() {
            clearInterval(TIMER_INTERVAL);
            toggleLoading(true);
            
            const payload = {
                action: 'submitUjian',
                dataSiswa: USER_INFO,
                jawabanSiswa: JAWABAN
            };

            try {
                const res = await apiRequest(payload);
                toggleLoading(false);
                
                if(res.status === 'sukses') {
                    localStorage.removeItem(`ans_${USER_INFO.nis}`);
                    document.getElementById('view-ujian').classList.add('hidden-view');
                    document.getElementById('view-selesai').classList.remove('hidden-view');
                    
                    if(res.nilai !== undefined) {
                        document.getElementById('score-card').classList.remove('hidden-view');
                        document.getElementById('lbl-skor').innerText = res.nilai;
                    }
                } else {
                    alert("Gagal kirim jawaban: " + res.message);
                    toggleLoading(false);
                }
            } catch(e) {
                alert("Gagal mengirim data. Pastikan internet lancar dan coba tekan tombol Selesai lagi.");
                toggleLoading(false);
            }
        }

        async function apiRequest(data) {
            // Menggunakan fetch dengan mode 'no-cors' tidak memungkinkan kita membaca JSON response secara langsung
            // Namun, Google Apps Script Web App (jika diset 'Anyone') mendukung CORS standar.
            // Kita gunakan metode POST standar.
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            });
            return await response.json();
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if(show) el.classList.remove('hidden-view');
            else el.classList.add('hidden-view');
        }

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-slate-800';
            d.className = `${color} text-white px-6 py-3 rounded-xl shadow-lg text-sm font-bold fade-in`;
            d.innerText = msg;
            c.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }
    </script>
</body>
</html>
